\documentclass{article}
\usepackage{booktabs}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{caption}
\usepackage{listings}
\title{HW4}
\author{Zhijiia Chen}
\begin{document}
\maketitle

\paragraph{C.1} Use the following code fragment:
\begin{lstlisting}[language=Fortran]
    Loop:   ld x1,0(x2)     ;load x1 from address 0+x2 
            addi x1,x1,1    ;x1=x1+1
            sd x1,0,(x2)    ;store x1 at address 0+x2
            addi x2,x2,4    ;x2=x2+4
            sub x4,x3,x2    ;x4=x3-x2
            bnez x4,Loop    ;branch to Loop if x4!= 0
\end{lstlisting}

Assume that the initial value of x3 is x2+396.

\subparagraph{a.} Data hazards are caused by data dependencies in the code. Whether a dependency causes a hazard depends on the machine implementation (i.e., number of pipeline stages). List all of the data dependencies in the code above. Record the register, source instruction, and destination instruction; for example, there is a data dependency for register x1 from the ld to the addi.

\noindent \textbf{answer:}

x1 ld addi

x1 addi sd

x2 ld addi

x2 sd addi

x2 sub addi

x4 bnez sub

\subparagraph{b.} Show the timing of this instruction sequence for the 5-stage RISC pipeline without any forwarding or bypassing hardware but assuming that a register read and a write in the same clock cycle “forwards” through the register file, as between the add and or shown in Figure C.5. Use a pipeline timing chart like that in Figure C.8. Assume that the branch is handled by flushing the pipeline. If all memory references take 1 cycle, how many cycles does this loop take to execute?

\noindent \textbf{answer:} 

\begin{figure}[!ht]
\makebox[1 \textwidth][c]{
\resizebox{1.5 \textwidth}{!}{
    \begin{tabular}{r|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c} % <-- Alignments: 1st column left, 2nd middle and 3rd right, with vertical lines in between
    \toprule
    & \textbf{1} & \textbf{2}& \textbf{3}& \textbf{4}& \textbf{5}& \textbf{6}& \textbf{7}& \textbf{8}& \textbf{9}& \textbf{10}& \textbf{11}& \textbf{12}& \textbf{13}& \textbf{14}& \textbf{15}& \textbf{16}& \textbf{17}\\
    \hline
    ld x1,0(x2) &IF&ID& EX& MEM& WB&&&&&&&&&&&\\
    \hline
    addi x1,x1,1& &IF & Stall &Stall&ID &EX& MEM& WB&&&&&&&&\\
    \hline
    sd x1,0,(x2) & & & & &IF & Stall &Stall &ID& EX& MEM& WB&&&&&&\\
    \hline
    addi x2,x2,4 & & & & & & & &IF &ID& EX& MEM& WB&&&&\\
    \hline
    sub x4,x3,x2 & & & & & & & & &IF &Stall &Stall &ID& EX& MEM& WB&\\
    \hline
    bnez x4,Loop & & & & & & & & & & & &IF &ID& EX& MEM& WB&\\
    \hline
    ld x1,0(x2)  & & & & & & & & & & & & &IF&ID& EX& MEM& WB\\
    \bottomrule
    \end{tabular}
}
}
\end{figure}

Number of iteration = $\frac{396}{4}=99$. Loop 1 to loop 98 takes 16 cycles and the last loop takes 18 cycles, so this loop takes $98\times 16+18=1586$ cycles.

\subparagraph{c.} Show the timing of this instruction sequence for the 5-stage RISC pipeline with full forwarding and bypassing hardware. Use a pipeline timing chart like that shown in Figure C.8. Assume that the branch is handled by predicting it as not taken. If all memory references take 1 cycle, how many cycles does this loop take to execute?

\noindent \textbf{answer:} 

\begin{figure}[!ht]
\makebox[1 \textwidth][c]{
\resizebox{1.5 \textwidth}{!}{
    \begin{tabular}{r|c|c|c|c|c|c|c|c|c|c|c|c|c|c} % <-- Alignments: 1st column left, 2nd middle and 3rd right, with vertical lines in between
    \toprule
    & \textbf{1} & \textbf{2}& \textbf{3}& \textbf{4}& \textbf{5}& \textbf{6}& \textbf{7}& \textbf{8}& \textbf{9}& \textbf{10}& \textbf{11}& \textbf{12}& \textbf{13}& \textbf{14}\\
    \hline
    ld x1,0(x2) &IF&ID& EX& MEM& WB&&&&&&&&\\
    \hline
    addi x1,x1,1& &IF &ID &Stall&EX& MEM& WB&&&&&&\\
    \hline
    sd x1,0,(x2) & & & IF & Stall &ID& EX& MEM& WB&&&&&\\
    \hline
    addi x2,x2,4 & & & & & IF &ID& EX& MEM& WB&&&&\\
    \hline
    sub x4,x3,x2 & & & & & &IF &ID& EX& MEM& WB&&&\\
    \hline
    bnez x4,Loop & & & & & & & IF & Stall&ID& EX& MEM& WB&\\
    \hline
    (instruction after the loop) & & & & & & & & &IF&Flush& Flush& Flush& Flush\\
    \hline
    ld x1,0(x2) & & & & & & & & & &IF&ID& EX& MEM& WB\\
    \bottomrule
    \end{tabular}
}
}
\end{figure}

Number of iteration = $\frac{396}{4}=99$. Loop 1 to loop 98 takes 9 cycles and the last loop takes 12 cycles, so this loop takes $98\times 9+12=894$ cycles.

\subparagraph{d.} Show the timing of this instruction sequence for the 5-stage RISC pipeline with full forwarding and bypassing hardware, as shown in Figure C.6. Use a pipeline timing chart like that shown in Figure C.8. Assume that the branch is handled by predicting it as taken. If all memory references take 1 cycle, how many cycles does this loop take to execute?

\noindent \textbf{answer:} 

\begin{figure}[!ht]
\makebox[1 \textwidth][c]{
\resizebox{1.5 \textwidth}{!}{
    \begin{tabular}{r|c|c|c|c|c|c|c|c|c|c|c|c|c|c} % <-- Alignments: 1st column left, 2nd middle and 3rd right, with vertical lines in between
    \toprule
    & \textbf{1} & \textbf{2}& \textbf{3}& \textbf{4}& \textbf{5}& \textbf{6}& \textbf{7}& \textbf{8}& \textbf{9}& \textbf{10}& \textbf{11}& \textbf{12}& \textbf{13}& \textbf{14}\\
    \hline
    ld x1,0(x2) &IF&ID& EX& MEM& WB&&&&&&&&\\
    \hline
    addi x1,x1,1& &IF &ID &Stall&EX& MEM& WB&&&&&&\\
    \hline
    sd x1,0,(x2) & & & IF & Stall &ID& EX& MEM& WB&&&&&\\
    \hline
    addi x2,x2,4 & & & & & IF &ID& EX& MEM& WB&&&&\\
    \hline
    sub x4,x3,x2 & & & & & &IF &ID& EX& MEM& WB&&&\\
    \hline
    bnez x4,Loop & & & & & & & IF & Stall&ID& EX& MEM& WB&\\
    \hline
    ld x1,0(x2) & & & & & & & & &IF&ID& EX& MEM& WB&\\
    \bottomrule
    \end{tabular}
}
}
\end{figure}

Number of iteration = $\frac{396}{4}=99$. Loop 1 to loop 98 takes 8 cycles and the last loop takes 12 cycles, so this loop takes $98\times 8+12=796$ cycles.

\subparagraph{e.} High-performance processors have very deep pipelines—more than 15 stages. Imagine that you have a 10-stage pipeline in which every stage of the 5-stage pipeline has been split in two. The only catch is that, for data forwarding, data are forwarded from the end of a pair of stages to the beginning of the two stages where they are needed. For example, data are forwarded from the output of the second execute stage to the input of the first execute stage, still causing a 1-cycle delay. Show the timing of this instruction sequence for the 10-stage RISC pipeline with full forwarding and bypassing hardware. Use a pipeline timing chart like that shown in Figure C.8 (but with stages labeled IF1, IF2, ID1, etc.). Assume that the branch is handled by predicting it as taken. If all memory references take 1 cycle, how many cycles does this loop take to execute?

\noindent \textbf{answer:} 

\begin{figure}[!ht]
\makebox[1 \textwidth][c]{
\resizebox{1.5 \textwidth}{!}{
    \begin{tabular}{r|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c} % <-- Alignments: 1st column left, 2nd middle and 3rd right, with vertical lines in between
    \toprule
    & \textbf{1} & \textbf{2}& \textbf{3}& \textbf{4}& \textbf{5}& \textbf{6}& \textbf{7}& \textbf{8}& \textbf{9}& \textbf{10}& \textbf{11}& \textbf{12}& \textbf{13}& \textbf{14}& \textbf{15}& \textbf{16}& \textbf{17}& \textbf{18}& \textbf{19}& \textbf{20}& \textbf{21}& \textbf{22}& \textbf{23}\\
    \hline
    ld x1,0(x2) &IF1&IF2&ID1&ID2& EX1& EX2& MEM1& MEM2& WB1& WB2&&&&&&&&&&&&\\
    \hline
    addi x1,x1,1& &IF1&IF2&ID1&ID2&Stall& Stall& Stall& EX1& EX2& MEM1& MEM2& WB1& WB2&&&&&&&&\\
    \hline
    sd x1,0,(x2) & & &IF1&IF2&ID1&Stall& Stall& Stall&ID2& EX1& EX2& MEM1& MEM2& WB1& WB2&&&&&&&\\
    \hline
    addi x2,x2,4 & & & &IF1&IF2&Stall& Stall& Stall&ID1&ID2& EX1& EX2& MEM1& MEM2& WB1& WB2&&&&&&\\
    \hline
    sub x4,x3,x2 & & & & &IF1&Stall& Stall&Stall&IF2&ID1&ID2&Stall&EX1& EX2& MEM1& MEM2& WB1& WB2&&&&\\
    \hline
    bnez x4,Loop & & & & & & & & &IF1&IF2&Stall&Stall&Stall&Stall&ID1&ID2&EX1& EX2& MEM1& MEM2& WB1& WB2\\
    \hline
    ld x1,0(x2)  & & & & & & & & & &IF1&Stall&Stall&Stall&Stall&IF2&ID1&ID2&EX1& EX2& MEM1& MEM2& WB1& WB2\\
    \bottomrule
    \end{tabular}
}
}
\end{figure}

Number of iteration = $\frac{396}{4}=99$. Loop 1 to loop 98 takes 9 cycles and the last loop takes 22 cycles, so this loop takes $98\times 9+22=904$ cycles.

\subparagraph{f.} Assume that in the 5-stage pipeline, the longest stage requires 0.8 ns, and the pipeline register delay is 0.1 ns. What is the clock cycle time of the 5-stage pipeline? If the 10-stage pipeline splits all stages in half, what is the cycle time of the 10-stage machine?

\noindent \textbf{answer:} 

Cycle time for 5-stage pipeline = 0.8+0.1=0.9 ns. 

Cycle time for 10-stage pipeline = $\frac{0.8}{2}+0.1=0.5$ ns.

\subparagraph{g.} Using your answers from parts (d) and (e),determine the cycles per instruction (CPI) for the loop on a 5-stage pipeline and a 10-stage pipeline. Make sure you count only from when the first instruction reaches the write-back stage to the end. Do not count the start-up of the first instruction. Using the clock cycle time calculated in part (f), calculate the average instruction execute time for each machine.

\noindent \textbf{answer:}

CPI of 5-stage pipeline: $\frac{796}{99\times 6}=1.34$.

CPI of 10-stage pipeline: $\frac{904}{99\times 6}=1.52$.

Average instruction execution time of 5-stage: $1.34*0.92=1.21$ ns.

Average instruction execution time of 10-stage: $1.52*0.92=0.76$ ns.
\end{document}